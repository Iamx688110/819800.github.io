<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>陈金福的78小博客~</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/tailwindcss">
    @layer utilities {
      .printer-text {
        border-right: 2px solid #1e293b;
        white-space: nowrap;
        animation: blink-caret 0.75s step-end infinite;
      }
      @keyframes blink-caret {
        from, to { border-color: transparent; }
        50% { border-color: #1e293b; }
      }
      .fullscreen-iframe {
        height: calc(100vh - 80px);
        width: 100%; /* 确保iframe宽度100% */
        border: none;
      }
      .strength-bar {
        transition: width 0.3s ease;
      }
    }
  </style>
</head>
<body class="bg-white min-h-screen text-gray-800 m-0 p-0"> <!-- 移除body默认边距 -->
  <!-- 未登录容器 -->
  <div id="unauth-container" class="container mx-auto px-4 py-8">
    <!-- 头像+标题+打印机文字 -->
    <div class="flex flex-col items-center mb-8">
      <img 
        src="https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/95d2b1e9f19141dcae202f7f6ce4ba93.png~tplv-a9rns2rl98-24:720:720.png?lk3s=8e244e95&rcl=20260204193641608208B2E186440206FB&rrcfp=8a172a1a&x-expires=1770809801&x-signature=P6zeJ2t7SeOIpX7gd7bhsMcHo1U%3D" 
        alt="博客头像" 
        class="w-24 h-24 rounded-full mb-4 border-2 border-gray-200 shadow-sm"
      >
      <h1 id="blog-title" class="text-2xl font-bold mb-4">陈金福的78小博客</h1>
      <div id="printer-container" class="text-lg font-medium"></div>
    </div>

    <!-- 登录注册 + 公告栏（左右各占一半） -->
    <div class="flex gap-6">
      <!-- 登录/注册窗口（缩半） -->
      <div class="w-1/2">
        <!-- 登录表单 -->
        <div id="login-form" class="bg-white p-8 rounded-lg shadow-md">
          <h2 class="text-xl font-bold mb-6">登录</h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="login-username">用户名</label>
              <input 
                type="text" 
                id="login-username" 
                class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/50"
                placeholder="请输入用户名"
              >
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="login-password">密码</label>
              <input 
                type="password" 
                id="login-password" 
                class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/50"
                placeholder="请输入密码"
              >
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="login-captcha">验证码</label>
              <div class="flex gap-2">
                <input 
                  type="text" 
                  id="login-captcha" 
                  class="flex-1 px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/50"
                  placeholder="请输入验证码"
                >
                <div id="captcha-img" class="w-32 h-10 bg-gray-100 rounded-lg flex items-center justify-center font-mono cursor-pointer" onclick="refreshCaptcha()">点击刷新</div>
              </div>
            </div>
            <button id="login-btn" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center gap-2">
              <i class="fa fa-sign-in"></i> 登录
            </button>
            <p class="text-sm text-center mt-4">还没有账号？ <a href="javascript:showRegister()" class="text-blue-500 hover:underline">立即注册</a></p>
          </div>
        </div>

        <!-- 注册表单（默认隐藏） -->
        <div id="register-form" class="bg-white p-8 rounded-lg shadow-md hidden">
          <h2 class="text-xl font-bold mb-6">注册</h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="reg-username">用户名</label>
              <input 
                type="text" 
                id="reg-username" 
                class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/50"
                placeholder="请设置用户名"
              >
              <p id="username-tip" class="text-xs mt-1 hidden"></p>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="reg-password">密码</label>
              <input 
                type="password" 
                id="reg-password" 
                class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/50"
                placeholder="请设置密码（字母+数字，≥8位）"
              >
              <!-- 密码强度检测 -->
              <div class="mt-2">
                <div class="flex justify-between text-xs mb-1">
                  <span>密码强度</span>
                  <span id="password-strength-text">弱</span>
                </div>
                <div class="w-full h-2 bg-gray-100 rounded-full overflow-hidden">
                  <div id="password-strength-bar" class="strength-bar h-full bg-red-500 w-0"></div>
                </div>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="reg-captcha">验证码</label>
              <div class="flex gap-2">
                <input 
                  type="text" 
                  id="reg-captcha" 
                  class="flex-1 px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/50"
                  placeholder="请输入验证码"
                >
                <div id="reg-captcha-img" class="w-32 h-10 bg-gray-100 rounded-lg flex items-center justify-center font-mono cursor-pointer" onclick="refreshRegCaptcha()">点击刷新</div>
              </div>
            </div>
            <button id="register-btn" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center gap-2">
              <i class="fa fa-user-plus"></i> 注册
            </button>
            <p class="text-sm text-center mt-4">已有账号？ <a href="javascript:showLogin()" class="text-blue-500 hover:underline">立即登录</a></p>
          </div>
        </div>
      </div>

      <!-- 公告栏（占另一半） -->
      <div class="w-1/2">
        <div class="bg-white p-8 rounded-lg shadow-md h-full">
          <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
            <i class="fa fa-bullhorn text-blue-500"></i> 公告栏
          </h2>
          <div id="announcement-list" class="space-y-3">
            <!-- 公告内容从config.json加载 -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 登录后容器（默认隐藏） - 关键修改：移除container限制，取消px-4内边距 -->
  <div id="auth-container" class="w-full py-4 hidden">
    <!-- 头部：欢迎语 + 退出按钮 - 关键修改：调整内边距和宽度 -->
    <div class="bg-white shadow-sm rounded-lg p-4 mb-4 flex justify-between items-center mx-4">
      <h2 id="welcome-text" class="text-xl font-bold"></h2>
      <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors flex items-center gap-2">
        <i class="fa fa-sign-out"></i> 退出登录
      </button>
    </div>
    <!-- 全屏博客内容框 - 关键修改：移除rounded-lg和shadow-md的左右边距，占满宽度 -->
    <div class="bg-white overflow-hidden w-full">
      <iframe 
        src="https://iamx688110.github.io" 
        class="fullscreen-iframe"
        title="78小博客内容"
      ></iframe>
    </div>
  </div>

  <script>
    // 全局变量
    let currentCaptcha = ''; // 登录验证码
    let currentRegCaptcha = ''; // 注册验证码
    const printerTexts = [
      "欢迎来到78小博客~",
      "在这里记录生活与学习",
      "注册账号即可解锁全部内容",
      "安全登录，保护你的隐私",
      "每一次访问都是新的开始"
    ];

    // ====================== 初始化 ======================
    window.onload = function() {
      // 1. 加载公告
      loadAnnouncements();
      // 2. 初始化验证码
      refreshCaptcha();
      refreshRegCaptcha();
      // 3. 启动打印机文字效果
      startPrinterEffect();
      // 4. 绑定登录/注册/退出事件
      bindEvents();
      // 5. 检查是否已登录（刷新页面后保持登录状态）
      checkLoginStatus();
    };

    // ====================== 多用户存储核心方法 ======================
    // 1. 获取所有用户（合并初始用户+本地注册用户）
    function getAllUsers() {
      // 从localStorage读取已注册用户
      const localUsers = JSON.parse(localStorage.getItem('blogUsers')) || [];
      // 从config.json读取初始用户（如果需要）
      // 这里可替换为实际的config.json请求，示例中直接写死初始用户
      const defaultUsers = [
        { username: "admin", password: "Admin123456" }
      ];
      // 合并并去重（避免初始用户重复）
      const allUsers = [...defaultUsers];
      localUsers.forEach(user => {
        if (!allUsers.some(u => u.username === user.username)) {
          allUsers.push(user);
        }
      });
      return allUsers;
    }

    // 2. 保存新用户到localStorage（支持多用户）
    function saveNewUser(username, password) {
      const localUsers = JSON.parse(localStorage.getItem('blogUsers')) || [];
      // 检查是否重名（核心：多用户不重复）
      if (localUsers.some(user => user.username === username)) {
        return { success: false, message: "用户名已存在" };
      }
      // 添加新用户
      localUsers.push({ username, password });
      localStorage.setItem('blogUsers', JSON.stringify(localUsers));
      return { success: true, message: "注册成功" };
    }

    // 3. 验证用户登录（支持多用户校验）
    function verifyUser(username, password) {
      const allUsers = getAllUsers();
      const user = allUsers.find(u => u.username === username && u.password === password);
      return !!user; // 存在则返回true，否则false
    }

    // ====================== 公告加载 ======================
    function loadAnnouncements() {
      // 模拟从config.json加载公告（GitHub Pages可直接请求）
      // 实际可替换为fetch('config.json').then(...)
      const announcements = [
        "欢迎访问78小博客，使用前请完成注册登录",
        "本博客仅用于学习交流，请勿发布违规内容",
        "忘记密码请联系管理员重置",
        "注册时密码需包含字母+数字，长度≥8位",
        "登录后可访问完整博客内容"
      ];
      
      const announcementList = document.getElementById('announcement-list');
      announcementList.innerHTML = '';
      announcements.forEach((ann, index) => {
        const item = document.createElement('div');
        item.className = 'p-3 bg-gray-50 rounded-lg border border-gray-100 flex items-start gap-2';
        item.innerHTML = `
          <i class="fa fa-circle text-xs text-blue-500 mt-1"></i>
          <span>${index + 1}. ${ann}</span>
        `;
        announcementList.appendChild(item);
      });
    }

    // ====================== 验证码生成 ======================
    function generateCaptcha() {
      const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
      let captcha = '';
      for (let i = 0; i < 4; i++) {
        captcha += chars[Math.floor(Math.random() * chars.length)];
      }
      return captcha;
    }

    function refreshCaptcha() {
      currentCaptcha = generateCaptcha();
      document.getElementById('captcha-img').textContent = currentCaptcha;
    }

    function refreshRegCaptcha() {
      currentRegCaptcha = generateCaptcha();
      document.getElementById('reg-captcha-img').textContent = currentRegCaptcha;
    }

    // ====================== 打印机文字效果 ======================
    function startPrinterEffect() {
      const container = document.getElementById('printer-container');
      let textIndex = 0;
      let charIndex = 0;
      let isDeleting = false;

      function typeWriter() {
        const currentText = printerTexts[textIndex];
        if (!isDeleting) {
          // 打字阶段
          container.textContent = currentText.substring(0, charIndex + 1);
          container.classList.add('printer-text');
          charIndex++;
          if (charIndex === currentText.length) {
            // 打完后停顿2秒
            setTimeout(() => { isDeleting = true; }, 2000);
          } else {
            setTimeout(typeWriter, 150);
          }
        } else {
          // 删除阶段
          container.textContent = currentText.substring(0, charIndex - 1);
          charIndex--;
          if (charIndex === 0) {
            // 删完后切换文字
            isDeleting = false;
            textIndex = (textIndex + 1) % printerTexts.length;
            setTimeout(typeWriter, 500);
          } else {
            setTimeout(typeWriter, 80);
          }
        }
      }
      typeWriter();
    }

    // ====================== 密码强度检测 ======================
    function checkPasswordStrength(password) {
      let strength = 0;
      // 长度≥8
      if (password.length >= 8) strength += 1;
      // 包含字母
      if (/[a-zA-Z]/.test(password)) strength += 1;
      // 包含数字
      if (/\d/.test(password)) strength += 1;
      // 包含特殊字符（可选）
      if (/[^a-zA-Z0-9]/.test(password)) strength += 1;

      // 更新强度条和文字
      const bar = document.getElementById('password-strength-bar');
      const text = document.getElementById('password-strength-text');
      const width = (strength / 4) * 100;
      
      bar.style.width = `${width}%`;
      if (strength <= 1) {
        bar.className = 'strength-bar h-full bg-red-500 w-0';
        text.textContent = '弱';
        text.style.color = '#ef4444';
      } else if (strength === 2) {
        bar.className = 'strength-bar h-full bg-yellow-500 w-0';
        text.textContent = '中';
        text.style.color = '#eab308';
      } else if (strength === 3) {
        bar.className = 'strength-bar h-full bg-green-500 w-0';
        text.textContent = '强';
        text.style.color = '#22c55e';
      } else {
        bar.className = 'strength-bar h-full bg-blue-500 w-0';
        text.textContent = '极强';
        text.style.color = '#3b82f6';
      }
      return strength >= 2; // 至少中等强度才能注册
    }

    // ====================== 事件绑定 ======================
    function bindEvents() {
      // 1. 密码强度检测事件
      document.getElementById('reg-password').addEventListener('input', function(e) {
        checkPasswordStrength(e.target.value);
      });

      // 2. 用户名查重事件
      document.getElementById('reg-username').addEventListener('blur', function(e) {
        const username = e.target.value.trim();
        const tip = document.getElementById('username-tip');
        tip.classList.remove('hidden');
        
        if (username === '') {
          tip.textContent = '用户名不能为空';
          tip.style.color = '#ef4444';
          return;
        }

        const allUsers = getAllUsers();
        if (allUsers.some(user => user.username === username)) {
          tip.textContent = '用户名已存在，请更换';
          tip.style.color = '#ef4444';
        } else {
          tip.textContent = '用户名可用';
          tip.style.color = '#22c55e';
        }
      });

      // 3. 登录按钮事件
      document.getElementById('login-btn').addEventListener('click', function() {
        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value.trim();
        const captcha = document.getElementById('login-captcha').value.trim().toUpperCase();

        // 校验
        if (!username || !password) {
          alert('用户名或密码不能为空！');
          return;
        }
        if (captcha !== currentCaptcha.toUpperCase()) {
          alert('验证码错误！');
          refreshCaptcha();
          return;
        }

        // 验证用户（支持多用户）
        if (verifyUser(username, password)) {
          // 登录成功：保存登录状态
          localStorage.setItem('loggedUser', username);
          showAuthContainer(username);
        } else {
          alert('用户名或密码错误！');
          refreshCaptcha();
        }
      });

      // 4. 注册按钮事件
      document.getElementById('register-btn').addEventListener('click', function() {
        const username = document.getElementById('reg-username').value.trim();
        const password = document.getElementById('reg-password').value.trim();
        const captcha = document.getElementById('reg-captcha').value.trim().toUpperCase();

        // 基础校验
        if (!username || !password) {
          alert('用户名或密码不能为空！');
          return;
        }
        if (captcha !== currentRegCaptcha.toUpperCase()) {
          alert('验证码错误！');
          refreshRegCaptcha();
          return;
        }

        // 密码强度校验
        if (!checkPasswordStrength(password)) {
          alert('密码强度不足！需包含字母+数字，长度≥8位');
          return;
        }

        // 保存新用户（多用户逻辑）
        const result = saveNewUser(username, password);
        if (result.success) {
          alert('注册成功！请登录');
          showLogin(); // 切回登录页
          // 清空注册表单
          document.getElementById('reg-username').value = '';
          document.getElementById('reg-password').value = '';
          document.getElementById('reg-captcha').value = '';
          refreshRegCaptcha();
        } else {
          alert(result.message);
        }
      });

      // 5. 退出按钮事件
      document.getElementById('logout-btn').addEventListener('click', function() {
        localStorage.removeItem('loggedUser');
        // 重置并显示未登录容器
        document.getElementById('auth-container').classList.add('hidden');
        document.getElementById('unauth-container').classList.remove('hidden');
        document.getElementById('login-username').value = '';
        document.getElementById('login-password').value = '';
        document.getElementById('login-captcha').value = '';
        refreshCaptcha();
      });
    }

    // ====================== 页面切换 ======================
    function showRegister() {
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('register-form').classList.remove('hidden');
    }

    function showLogin() {
      document.getElementById('register-form').classList.add('hidden');
      document.getElementById('login-form').classList.remove('hidden');
    }

    function showAuthContainer(username) {
      // 隐藏未登录容器，显示登录后容器
      document.getElementById('unauth-container').classList.add('hidden');
      document.getElementById('auth-container').classList.remove('hidden');
      // 设置欢迎语
      document.getElementById('welcome-text').textContent = `欢迎 ${username} 登录78小博客`;
    }

    // 检查登录状态（刷新页面后保持）
    function checkLoginStatus() {
      const loggedUser = localStorage.getItem('loggedUser');
      if (loggedUser) {
        showAuthContainer(loggedUser);
      }
    }
  </script>
</body>

</html>
